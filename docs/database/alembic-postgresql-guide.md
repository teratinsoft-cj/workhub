# Alembic with PostgreSQL - Complete Guide

This guide ensures all tables are properly managed with Alembic for PostgreSQL.

## Verify All Models Are Detected

Before creating migrations, verify Alembic can detect all your models:

```bash
cd backend
source venv/bin/activate
python verify_alembic_models.py
```

This will show:
- All tables detected by Alembic
- Column details for each table
- Any missing tables

## Create Initial Migration for PostgreSQL

### Step 1: Ensure Database is Empty

For a fresh PostgreSQL database:

```bash
# Connect to PostgreSQL
sudo -u postgres psql -d workhub

# Drop all tables if they exist (BE CAREFUL!)
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO workhub;
GRANT ALL ON SCHEMA public TO public;
\q
```

### Step 2: Create Autogenerated Migration

```bash
cd backend
source venv/bin/activate

# Create a new migration with autogenerate
alembic revision --autogenerate -m "Initial schema for PostgreSQL"

# This will create a new file in alembic/versions/
# Review the generated migration file
```

### Step 3: Review and Edit Migration

The autogenerated migration should include all tables. Check:

1. All 14 tables are created:
   - users
   - project_sources
   - projects
   - developer_projects
   - task_developers
   - tasks
   - timesheets
   - invoices
   - payments
   - invoice_tasks
   - payment_vouchers
   - payment_voucher_tasks
   - developer_payments
   - developer_payment_tasks

2. Enum types are created for PostgreSQL:
   - userrole
   - timesheetstatus
   - paymentstatus
   - projectstatus

3. All foreign keys are included

4. All indexes are included

### Step 4: Apply Migration

```bash
# Apply the migration
alembic upgrade head

# Verify tables were created
sudo -u postgres psql -d workhub -c "\dt"
```

## Update Existing Migrations for PostgreSQL

If you have existing migrations that were created for SQLite:

### Option 1: Create New Migration (Recommended)

```bash
# Create a new migration that adds any missing elements
alembic revision --autogenerate -m "Update schema for PostgreSQL compatibility"
```

### Option 2: Edit Existing Migration

Edit the migration file to:
1. Remove SQLite-specific code
2. Add PostgreSQL enum type creation
3. Ensure proper data types

Example enum creation for PostgreSQL:

```python
def upgrade():
    # Create enum types for PostgreSQL
    op.execute("""
        DO $$ BEGIN
            CREATE TYPE userrole AS ENUM ('super_admin', 'project_lead', 'project_owner', 'developer');
        EXCEPTION
            WHEN duplicate_object THEN null;
        END $$;
    """)
    
    # Rest of migration...
```

## Verify All Tables Exist

After running migrations:

```bash
# List all tables
sudo -u postgres psql -d workhub -c "\dt"

# Should show all 14 tables:
# users
# project_sources
# projects
# developer_projects
# task_developers
# tasks
# timesheets
# invoices
# payments
# invoice_tasks
# payment_vouchers
# payment_voucher_tasks
# developer_payments
# developer_payment_tasks
```

## Check Table Structure

Verify each table has correct columns:

```sql
-- Check users table
\d users

-- Check projects table
\d projects

-- Check tasks table
\d tasks

-- etc.
```

## Common Issues and Solutions

### Issue: Enum types not created

**Solution:**
```python
# In migration, create enum types first:
op.execute("CREATE TYPE userrole AS ENUM ('super_admin', 'project_lead', 'project_owner', 'developer');")
```

### Issue: Foreign key constraints fail

**Solution:**
Ensure tables are created in the correct order:
1. users (referenced by many tables)
2. project_sources
3. projects
4. tasks
5. Other tables

### Issue: Migration fails with "table already exists"

**Solution:**
```bash
# Check current migration version
alembic current

# If needed, stamp the database
alembic stamp head

# Or downgrade and re-upgrade
alembic downgrade -1
alembic upgrade head
```

### Issue: Autogenerate doesn't detect changes

**Solution:**
1. Ensure all models are imported in `alembic/env.py`:
   ```python
   from models import *
   ```

2. Verify `target_metadata = Base.metadata` in `alembic/env.py`

3. Run verification script:
   ```bash
   python verify_alembic_models.py
   ```

## Production Checklist

- [ ] All 14 tables exist in database
- [ ] All enum types created (for PostgreSQL)
- [ ] All foreign keys are in place
- [ ] All indexes are created
- [ ] Migration history is clean (`alembic history`)
- [ ] Current version matches head (`alembic current`)
- [ ] Can create/read/update/delete records
- [ ] Foreign key relationships work correctly

## Creating New Migrations

When adding new models or columns:

1. **Update the model** in `models.py`

2. **Create migration:**
   ```bash
   alembic revision --autogenerate -m "Add new feature"
   ```

3. **Review the migration file** - ensure it's correct

4. **Test the migration:**
   ```bash
   # Test upgrade
   alembic upgrade head
   
   # Test downgrade (if needed)
   alembic downgrade -1
   alembic upgrade head
   ```

5. **Commit the migration** to version control

## Migration Best Practices

1. **Always review autogenerated migrations** - Alembic can miss some changes

2. **Test migrations on a copy** of production data first

3. **Keep migrations small** - one logical change per migration

4. **Never edit applied migrations** - create a new migration to fix issues

5. **Use descriptive migration messages**

6. **Test both upgrade and downgrade** paths

## Useful Commands

```bash
# Show migration history
alembic history

# Show current version
alembic current

# Show pending migrations
alembic heads

# Create new migration
alembic revision --autogenerate -m "Description"

# Apply migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Rollback to specific version
alembic downgrade <revision_id>

# Show SQL for migration (without applying)
alembic upgrade head --sql
```

## Verification Script

Run this after migrations to verify everything:

```bash
cd backend
source venv/bin/activate
python verify_alembic_models.py
```

This will show:
- All detected tables
- Column details
- Any missing tables

---

**Next Steps:**
1. Run `python verify_alembic_models.py` to verify model detection
2. Create initial migration: `alembic revision --autogenerate -m "Initial schema"`
3. Review and apply: `alembic upgrade head`
4. Verify: `sudo -u postgres psql -d workhub -c "\dt"`

